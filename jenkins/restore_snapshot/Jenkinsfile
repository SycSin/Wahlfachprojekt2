pipeline {
    agent any
    
    parameters {
        string(name: 'WORKER', defaultValue: 'worker01', description: 'Choose one of worker01, worker02, or worker03')
    }
    
    environment {
        SSH_USER = 'root'
        SSH_HOST = '192.168.1.210'
        SSH_COMMAND = "rsync -a --delete /mnt/ssd/nfs/worker-base-template/ /mnt/ssd/nfs/${params.WORKER}"
    }
    
    stages {
        stage('SSH and Execute Rsync') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(credentialsId: 'jenkins-private-key-base64', keyFileVariable: 'SSH_KEY')]) {
                        // Start the SSH agent and run the rsync command
                        sshagent(['sshagent']) {
                            sh "ssh -o StrictHostKeyChecking=no -i $SSH_KEY ${SSH_USER}@${SSH_HOST} '$SSH_COMMAND'"
                        }
                    }
                }
            }
        }
    }
}
